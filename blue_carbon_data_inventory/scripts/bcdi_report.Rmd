---
title: "US Blue Carbon Data Inventory"
author: "Coastal Carbon Network"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: spacelab
    highlight: tango
---

```{r setup, include=FALSE}
# this sets the working directory to start where the R project is located
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# no warnings or messages
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

```

## Report Card Score Breakdown

### First Iteration

```{r v1-report, fig.height=12, fig.width=12}

state_rank <- scores_v1 %>%
  filter(metric == "Total") %>%
  mutate(normalized_rank = ifelse(is.na(normalized_rank), 5, normalized_rank)) %>%
  arrange(-normalized_rank)

scores_v1 %>%
  mutate(metric = factor(metric, c("Total", "Quantity", "Quality", "Spatial coverage", "Habitat coverage"))) %>%
  mutate(state = factor(state, state_rank$state)) %>%
  mutate(normalized_rank = as.character(normalized_rank)) %>%
  ggplot(aes(metric, state, fill = normalized_rank)) +
  geom_tile(color = "white", size = 0.5) +
  # coord_equal() +
  # geom_hline(aes(yintercept = 6.5), size = 0.5, col = "grey") +
  # geom_hline(aes(yintercept = 9.5), size = 0.5, col = "grey") +
  # geom_hline(aes(yintercept = 17.5), size = 0.5, col = "grey") +
  # geom_hline(aes(yintercept = 21.5), size = 0.5, col = "grey") +
  geom_vline(aes(xintercept = 1.5), size = 0.5, col = "black") +
  ylab(NULL) + xlab(NULL) +
  scale_fill_brewer(palette = "RdYlBu", direction = -1,
                    labels = c("Best", "", "", "Fair", "", "", "Poor", "No Data")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + # wrap text

  # facet_wrap(vars(metric)) +
  theme_bw(base_size = 15) +
  theme(legend.title = element_blank(),
    # axis.text.x = element_text(angle = 90),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
   ggtitle("State-Level Blue Carbon Data Report Card (V1)")

ggsave("blue_carbon_data_inventory/figures/cerf_figs/report_card_v1.jpg", width = 6, height = 6)

```

### Second Iteration

```{r v2-report, fig.height=12, fig.width=12}

state_rank2 <- scores_v2 %>%
  filter(metric == "Total") %>%
  mutate(normalized_rank = ifelse(is.na(normalized_rank), 5, normalized_rank)) %>%
  arrange(-normalized_rank)

scores_v2 %>%
  mutate(metric = factor(metric, c("Total", "Quantity", "Quality", "Spatial coverage", "Habitat coverage"))) %>%
  mutate(state = factor(state, state_rank2$state)) %>%
  mutate(normalized_rank = as.character(normalized_rank)) %>%
  ggplot(aes(metric, state, fill = normalized_rank)) +
  geom_tile(color = "white", size = 0.5) +
  # coord_equal() +
  # geom_hline(aes(yintercept = 6.5), size = 0.5, col = "grey") +
  # geom_hline(aes(yintercept = 9.5), size = 0.5, col = "grey") +
  # geom_hline(aes(yintercept = 17.5), size = 0.5, col = "grey") +
  # geom_hline(aes(yintercept = 21.5), size = 0.5, col = "grey") +
  geom_vline(aes(xintercept = 1.5), size = 0.5, col = "black") +
  ylab(NULL) + xlab(NULL) +
  scale_fill_brewer(palette = "RdYlBu", direction = -1,
                    labels = c("Best", "", "", "Fair", "", "", "Poor", "No Data")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + # wrap text
  # facet_wrap(vars(metric)) +
  theme_bw(base_size = 15) +
  theme(legend.title = element_blank(),
        # axis.text.x = element_text(angle = 90),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
   ggtitle("State-Level Blue Carbon Data Report Card (V2)")

ggsave("blue_carbon_data_inventory/figures/cerf_figs/report_card_v2.jpg", width = 6, height = 6)
```

## Data Inventory Change

```{r comparison, echo=FALSE, warning=FALSE, message=FALSE}
v1 <- v1_metrics %>% 
  select(-c(contains("_weight"), contains("_rank"), contains("mean_"))) %>% 
  rename(spatial_metric = spatial_representativeness_metric) %>% 
  mutate(habitat_metric = ifelse(state == "PA" | state == "DC", NA, habitat_metric))

v2 <- v2_metrics %>% 
  select(-c(contains("_weight"), contains("_rank"), contains("mean_"))) %>% 
  rename(spatial_metric = spatial_representativeness_metric) %>% 
    mutate(habitat_metric = ifelse(state == "PA" | state == "DC", NA, habitat_metric))
# add v2 to distinquish these metrics in the wide format
colnames(v2)[2:length(names(v2))] <- paste0(colnames(v2)[2:length(names(v2))], "_v2")

all_metrics <- full_join(v1, v2) %>% 
  mutate(across(everything(), replace_na, 0)) %>% 
  mutate(quant_diff = quantity_metric_v2 - quantity_metric,
         qual_diff = quality_metric_v2 - quality_metric,
         spatial_diff = spatial_metric_v2 - spatial_metric, 
         hab_diff = habitat_metric_v2 - habitat_metric)

```

<!-- ### State-Based Overview -->

```{r state-change, fig.height=12, fig.width=12, eval=FALSE}
# try a state-based visualization instead

# all_metrics_long <- all_metrics %>% 
#   select(state, contains("diff")) %>% 
#   pivot_longer(cols = -state, names_to = "metric", values_to = "change") %>% 
#   mutate(metric = recode(metric, 
#                          "spatial_diff" = "Spatial",
#                          "quant_diff" = "Quantity",
#                          "qual_diff" = "Quality",
#                           "hab_diff" = "Habitat"))
# 
# all_metrics_long %>% 
#   ggplot(aes(metric, change, col = metric)) +
#   geom_point(size = 3) +
#   geom_segment(aes(xend = metric, yend = 0)) +
#   coord_flip() +
#   facet_wrap(~state, dir = "v") +
#   theme_bw(base_size = 20) +
#     theme(legend.position = "bottom")

```

<!-- ### Metric-Based Overview -->

```{r metric-change, fig.height=12, fig.width=12, eval=FALSE}

# all_metrics_long %>% 
#   ggplot(aes(state, change, col = state)) +
#   geom_point(size = 3) +
#   geom_segment(aes(xend = state, yend = 0)) +
#   coord_flip() +
#   facet_wrap(~metric, nrow = 1) +
#   theme_bw(base_size = 20) +
#   theme(legend.position = "none")
```

### Quantity

```{r echo=FALSE, message=FALSE, fig.width=12, fig.height=7}

all_metrics %>% 
  mutate(state = fct_reorder(state, quantity_metric)) %>% 
  select(state, contains("quantity")) %>% 
  pivot_longer(cols = -state, names_to = "metric_iteration", values_to = "score") %>% 
  ggplot() +
  geom_point(aes(score, state, col = metric_iteration), alpha = 0.5, size = 3) +
  geom_segment(data = all_metrics %>% 
                 filter(quant_diff > 0), aes(y = state, yend = state, x = quantity_metric, xend = quantity_metric_v2), 
               colour = "black", arrow = arrow(length = unit(0.2, "cm"))) +
  # facet_wrap(climate_zone ~ management, dir = "h") +
  xlab("Cores per 1000ha Wetland Habitat") + ylab("") +
  theme_bw(base_size = 15) +
  theme(legend.position="bottom") +
  ggtitle("Change in Quantity of Available Cores per State")

ggsave("blue_carbon_data_inventory/figures/cerf_figs/change_quantity.jpg", width = 6, height = 6)
```

### Quality

```{r echo=FALSE, message=FALSE, fig.width=12, fig.height=7}

all_metrics %>% 
  mutate(state = fct_reorder(state, quality_metric)) %>% 
  select(state, contains("quality")) %>% 
  pivot_longer(cols = -state, names_to = "metric_iteration", values_to = "score") %>% 
  ggplot() +
  geom_point(aes(score, state, col = metric_iteration), alpha = 0.5, size = 3) +
  geom_segment(data = all_metrics %>% 
                 filter(qual_diff > 0), aes(y = state, yend = state, x = quality_metric, xend = quality_metric_v2), 
               colour = "black", arrow = arrow(length = unit(0.2, "cm"))) +
  # facet_wrap(climate_zone ~ management, dir = "h") +
  xlab("Cores per 1000ha Wetland Habitat") + ylab("") +
  theme_bw(base_size = 15) +
  theme(legend.position="bottom") +
  ggtitle("Change in Use and Completeness of Cores")

ggsave("blue_carbon_data_inventory/figures/cerf_figs/change_quality.jpg", width = 6, height = 6)
```

### Spatial Coverage

```{r echo=FALSE, message=FALSE, fig.width=12, fig.height=7}

all_metrics %>% 
  mutate(state = fct_reorder(state, spatial_metric)) %>% 
  select(state, contains("spatial_metric")) %>% 
  pivot_longer(cols = -state, names_to = "metric_iteration", values_to = "score") %>% 
  ggplot() +
  geom_point(aes(score, state, col = metric_iteration), alpha = 0.5, size = 3) +
  geom_segment(data = all_metrics %>% 
                 filter(spatial_diff != 0), aes(y = state, yend = state, x = spatial_metric, xend = spatial_metric_v2), 
               colour = "black", arrow = arrow(length = unit(0.2, "cm"))) +
  # facet_wrap(climate_zone ~ management, dir = "h") +
  xlab("Mean Sampling Distance\n/ Idealized Sampling Distance") + ylab("") +
  theme_bw(base_size = 15) +
  theme(legend.position="bottom") +
  ggtitle("Change in Spatial Coverage of Cores")

ggsave("blue_carbon_data_inventory/figures/cerf_figs/change_spatial.jpg", width = 6, height = 6)
```

### Habitat Coverage

```{r echo=FALSE, message=FALSE, fig.width=12, fig.height=7}

all_metrics %>% 
  mutate(state = fct_reorder(state, habitat_metric)) %>% 
  select(state, contains("habitat")) %>% 
  pivot_longer(cols = -state, names_to = "metric_iteration", values_to = "score") %>% 
  ggplot() +
  geom_point(aes(score, state, col = metric_iteration), alpha = 0.5, size = 3) +
  geom_segment(data = all_metrics %>% 
                 filter(hab_diff != 0), aes(y = state, yend = state, x = habitat_metric, xend = habitat_metric_v2), 
               colour = "black", arrow = arrow(length = unit(0.2, "cm"))) +
  # facet_wrap(climate_zone ~ management, dir = "h") +
  xlab("Difference Between Sampled\nand Mapped Proportions") + ylab("") +
  theme_bw(base_size = 15) +
  theme(legend.position="bottom") +
  ggtitle("Change in Habitat Representativeness of Cores")

ggsave("blue_carbon_data_inventory/figures/cerf_figs/change_habitat.jpg", width = 6, height = 6)

```

## Mapping Composite Scores

```{r}
# Common projection for states
states_aea <- st_transform(states, crs = "+proj=aea +ellps=WGS84 +lat_1=29.5 +lat_2=45.5 +lon_0=-96 +x_0=0 +y_0=0")

# filter for coastal states
coastal_states <- states_aea %>% 
  # filter(STUSPS %in% unique(all_metrics$state)) %>% 
  rename(state = STUSPS) %>% 
  full_join(all_metrics) %>% 
  full_join(scores_v1 %>% filter(metric == "Total") %>% select(-metric) %>% rename(normalized_rank_v1 = normalized_rank)) %>% 
  full_join(scores_v2 %>% filter(metric == "Total") %>% select(-metric) %>% rename(normalized_rank_v2 = normalized_rank)) 

## Map States with Composite Scores ####

# generate bounding box
b <- st_bbox(coastal_states %>% filter(state %in% unique(all_metrics$state)))


```

```{r fig.align='center'}
# ggplot score map V1
coastal_states %>% 
  ggplot(aes(fill = as.character(normalized_rank_v1))) +
  geom_sf() +
  scale_fill_brewer(palette = "RdYlBu", direction = -1,
                    name = "Composite Rank",
                    labels = c("Best", "", "Fair", "", "Poor", "No Data")) +
  # project aes w bounding box
  coord_sf(xlim = c(b["xmin"], b["xmax"]), ylim = c(b["ymin"], b["ymax"]),
           crs="+proj=aea +ellps=WGS84 +lat_1=29.5 +lat_2=45.5 +lon_0=-96 +x_0=0 +y_0=0") +
  # Probably want to take off x and y axes text
  theme_minimal() +
  # ggtitle("Change in the Quantity of Available Blue Carbon Data") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggplot score map V2
coastal_states %>% 
  ggplot(aes(fill = as.character(normalized_rank_v2))) +
  geom_sf() +
  # scale_fill_continuous(type = "viridis") +
  # scale_color_continuous() +
  scale_fill_brewer(palette = "RdYlBu", direction = -1,
                    name = "Composite Rank",
                    labels = c("Best", "", "Fair", "", "Poor", "No Data")) +
  # project aes w bounding box
  coord_sf(xlim = c(b["xmin"], b["xmax"]), ylim = c(b["ymin"], b["ymax"]),
           crs="+proj=aea +ellps=WGS84 +lat_1=29.5 +lat_2=45.5 +lon_0=-96 +x_0=0 +y_0=0") +
  # Probably want to take off x and y axes text
  theme_minimal() +
  # ggtitle("Change in the Quantity of Available Blue Carbon Data") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```



